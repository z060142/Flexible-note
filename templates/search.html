{% extends "base.html" %}

{% block title %}進階查詢 - 知識管理系統{% endblock %}

{% block extra_css %}
<style>
    .query-builder {
        background-color: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .query-type-card {
        cursor: pointer;
        transition: all 0.3s;
        height: 100%;
    }
    
    .query-type-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    .query-type-card.active {
        border: 2px solid #007bff;
        background-color: #e7f3ff;
    }
    
    .result-item {
        border-left: 4px solid #007bff;
        margin-bottom: 15px;
        padding: 15px;
        background-color: white;
        border-radius: 5px;
    }
    
    .relation-strength {
        display: inline-block;
        width: 50px;
        height: 5px;
        background-color: #ddd;
        border-radius: 3px;
        position: relative;
        margin-left: 10px;
    }
    
    .relation-strength-bar {
        position: absolute;
        height: 100%;
        background-color: #28a745;
        border-radius: 3px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <h1 class="mb-4"><i class="fas fa-search"></i> 進階查詢</h1>
    
    <!-- 查詢類型選擇 -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card query-type-card" onclick="selectQueryType('symptom_to_cause', event)">
                <div class="card-body text-center">
                    <i class="fas fa-stethoscope fa-3x text-primary mb-3"></i>
                    <h5>症狀診斷</h5>
                    <p class="text-muted small">從症狀找可能病因</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card query-type-card" onclick="selectQueryType('cause_to_treatment', event)">
                <div class="card-body text-center">
                    <i class="fas fa-pills fa-3x text-success mb-3"></i>
                    <h5>治療方案</h5>
                    <p class="text-muted small">從病因找治療方法</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card query-type-card" onclick="selectQueryType('method_analysis', event)">
                <div class="card-body text-center">
                    <i class="fas fa-hand-paper fa-3x text-warning mb-3"></i>
                    <h5>手法分析</h5>
                    <p class="text-muted small">查看手法適用範圍</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card query-type-card" onclick="selectQueryType('relation_map', event)">
                <div class="card-body text-center">
                    <i class="fas fa-project-diagram fa-3x text-danger mb-3"></i>
                    <h5>關聯圖譜</h5>
                    <p class="text-muted small">探索知識關聯</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 查詢建構器 -->
    <div class="query-builder" id="queryBuilder" style="display: none;">
        <h4 id="queryTitle">建構查詢</h4>
        
        <!-- 症狀診斷查詢 -->
        <div id="symptom_to_cause_builder" class="query-form" style="display: none;">
            <div class="mb-3">
                <label class="form-label">選擇症狀</label>
                <div class="tag-selector" id="symptomSelector">
                    <input type="text" class="form-control" placeholder="輸入症狀名稱..." 
                           id="symptomInput">
                </div>
                <div id="selectedSymptoms" class="mt-2"></div>
            </div>
            
            <div class="mb-3">
                <label class="form-label">症狀位置（選填）</label>
                <input type="text" class="form-control" id="symptomLocation" 
                       placeholder="例如：髖關節、腰椎、肩膀...">
            </div>
            
            <button class="btn btn-primary" onclick="executeQuery()">
                <i class="fas fa-search"></i> 查詢可能病因
            </button>
        </div>
        
        <!-- 治療方案查詢 -->
        <div id="cause_to_treatment_builder" class="query-form" style="display: none;">
            <div class="mb-3">
                <label class="form-label">選擇病因/問題</label>
                <div class="tag-selector" id="causeSelector">
                    <input type="text" class="form-control" placeholder="輸入病因名稱..." 
                           id="causeInput">
                </div>
                <div id="selectedCauses" class="mt-2"></div>
            </div>
            
            <div class="mb-3">
                <label class="form-label">偏好領域（選填）</label>
                <select class="form-select" id="preferredDomain">
                    <option value="">不限</option>
                    <option value="整復">整復</option>
                    <option value="點穴">點穴</option>
                    <option value="幹細胞">幹細胞</option>
                </select>
            </div>
            
            <button class="btn btn-primary" onclick="executeQuery()">
                <i class="fas fa-search"></i> 查詢治療方案
            </button>
        </div>
        
        <!-- 手法分析查詢 -->
        <div id="method_analysis_builder" class="query-form" style="display: none;">
            <div class="mb-3">
                <label class="form-label">選擇手法</label>
                <input type="text" class="form-control" id="methodInput" 
                       placeholder="輸入手法名稱...">
            </div>
            
            <button class="btn btn-primary" onclick="executeQuery()">
                <i class="fas fa-search"></i> 分析手法應用
            </button>
        </div>
        
        <!-- 關聯圖譜查詢 -->
        <div id="relation_map_builder" class="query-form" style="display: none;">
            <div class="mb-3">
                <label class="form-label">起始點</label>
                <input type="text" class="form-control" id="startPoint" 
                       placeholder="輸入症狀、病因或手法...">
            </div>
            
            <div class="mb-3">
                <label class="form-label">探索深度</label>
                <select class="form-select" id="exploreDepth">
                    <option value="1">1層關聯</option>
                    <option value="2" selected>2層關聯</option>
                    <option value="3">3層關聯</option>
                </select>
            </div>
            
            <button class="btn btn-primary" onclick="executeQuery()">
                <i class="fas fa-project-diagram"></i> 生成關聯圖
            </button>
        </div>
    </div>
    
    <!-- 查詢結果 -->
    <div id="queryResults" style="display: none;">
        <h4 class="mb-3">查詢結果</h4>
        <div id="resultsList"></div>
    </div>
    
    <!-- 關聯圖顯示區 -->
    <div id="relationGraphContainer" style="display: none;">
        <div class="card">
            <div class="card-body">
                <div id="relationGraph" style="height: 600px;"></div>
            </div>
        </div>
    </div>
</div>

<script>
let currentQueryType = null;
let selectedTags = {
    symptoms: [],
    causes: []
};

// 選擇查詢類型
function selectQueryType(type, event) {
    currentQueryType = type;
    
    // 更新UI
    document.querySelectorAll('.query-type-card').forEach(card => {
        card.classList.remove('active');
    });
    
    if (event && event.currentTarget) {
        event.currentTarget.classList.add('active');
    } else {
        const selectedCard = document.querySelector(`.query-type-card[onclick*="${type}"]`);
        if (selectedCard) {
            selectedCard.classList.add('active');
        }
    }
    
    // 顯示對應的查詢建構器
    document.getElementById('queryBuilder').style.display = 'block';
    document.querySelectorAll('.query-form').forEach(form => {
        form.style.display = 'none';
    });
    
    const builderElement = document.getElementById(`${type}_builder`);
    if (builderElement) {
        builderElement.style.display = 'block';
    }
    
    // 更新標題
    const titles = {
        'symptom_to_cause': '症狀診斷查詢',
        'cause_to_treatment': '治療方案查詢',
        'method_analysis': '手法分析查詢',
        'relation_map': '關聯圖譜查詢'
    };
    
    const titleElement = document.getElementById('queryTitle');
    if (titleElement) {
        titleElement.textContent = titles[type] || '建構查詢';
    }
    
    // 隱藏之前的結果
    document.getElementById('queryResults').style.display = 'none';
    document.getElementById('relationGraphContainer').style.display = 'none';
}

// 執行查詢
async function executeQuery() {
    if (!currentQueryType) {
        alert('請先選擇查詢類型');
        return;
    }
    
    const queryData = buildQueryData();
    
    try {
        const response = await fetch('/search', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(queryData)
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const results = await response.json();
        displayResults(results);
        
    } catch (error) {
        console.error('查詢失敗:', error);
        alert('查詢失敗，請重試: ' + error.message);
    }
}

// 建構查詢資料
function buildQueryData() {
    const data = {
        query_type: currentQueryType
    };
    
    try {
        switch(currentQueryType) {
            case 'symptom_to_cause':
                data.symptom_tags = selectedTags.symptoms.map(tag => tag.name);
                const locationInput = document.getElementById('symptomLocation');
                data.location = locationInput ? locationInput.value : '';
                break;
                
            case 'cause_to_treatment':
                data.cause_tags = selectedTags.causes.map(tag => tag.name);
                const domainSelect = document.getElementById('preferredDomain');
                data.preferred_domain = domainSelect ? domainSelect.value : '';
                break;
                
            case 'method_analysis':
                const methodInput = document.getElementById('methodInput');
                data.method_name = methodInput ? methodInput.value : '';
                break;
                
            case 'relation_map':
                const startPointInput = document.getElementById('startPoint');
                const depthSelect = document.getElementById('exploreDepth');
                data.start_point = startPointInput ? startPointInput.value : '';
                data.depth = depthSelect ? parseInt(depthSelect.value) : 2;
                break;
        }
    } catch (error) {
        console.error('建構查詢資料時出錯:', error);
    }
    
    return data;
}

// 顯示查詢結果
function displayResults(results) {
    if (currentQueryType === 'relation_map') {
        displayRelationGraph(results);
        return;
    }
    
    const container = document.getElementById('resultsList');
    if (!container) {
        console.error('找不到結果容器');
        return;
    }
    
    container.innerHTML = '';
    
    if (!results || !results.results || results.results.length === 0) {
        let message = '沒有找到相關結果';
        if (results && results.message) {
            message = results.message;
        }
        container.innerHTML = `<div class="alert alert-info">${message}</div>`;
    } else {
        results.results.forEach(result => {
            container.innerHTML += createResultItem(result);
        });
    }
    
    document.getElementById('queryResults').style.display = 'block';
}

// 創建結果項目
function createResultItem(result) {
    const title = result.segment_title || result.method_name || '無標題';
    const sessionTitle = result.session_title || '';
    const preview = result.segment_content_preview || result.description || '無描述';
    const sessionId = result.session_id || '#';
    const segmentId = result.segment_id || '';
    
    // 處理不同類型的標籤
    let tagsHTML = '';
    if (result.potential_cause_tags) {
        tagsHTML += result.potential_cause_tags.map(tag => 
            `<span class="badge me-1" style="background-color: ${tag.color || '#fd7e14'}">病因: ${tag.name}</span>`
        ).join('');
    }
    if (result.matched_symptoms) {
        tagsHTML += result.matched_symptoms.map(tag => 
            `<span class="badge me-1" style="background-color: ${tag.color || '#dc3545'}">症狀: ${tag.name}</span>`
        ).join('');
    }
    if (result.potential_treatment_tags) {
        tagsHTML += result.potential_treatment_tags.map(tag => 
            `<span class="badge me-1" style="background-color: ${tag.color || '#28a745'}">治療: ${tag.name}</span>`
        ).join('');
    }
    if (result.applicable_symptoms) {
        tagsHTML += result.applicable_symptoms.map(tag => 
            `<span class="badge me-1" style="background-color: ${tag.color || '#dc3545'}">適用症狀: ${tag.name}</span>`
        ).join('');
    }
    
    // 處理強度顯示
    let strengthHTML = '';
    if (typeof result.strength !== 'undefined' && result.strength !== null) {
        const strengthPercent = Math.round(result.strength * 100);
        strengthHTML = `
            <div class="mb-2">
                關聯強度：
                <span class="relation-strength">
                    <span class="relation-strength-bar" style="width: ${strengthPercent}%"></span>
                </span>
                <small class="text-muted">${strengthPercent}%</small>
            </div>
        `;
    }

    return `
        <div class="result-item">
            <h5>${title}</h5>
            ${sessionTitle ? `<h6 class="text-muted">來源課程: ${sessionTitle}</h6>` : ''}
            <p class="text-muted">${preview}</p>
            
            <div class="mb-2">
                ${tagsHTML}
            </div>
            
            ${strengthHTML}
            
            <div class="mt-2">
                <a href="/session/${sessionId}${segmentId ? '#segment-' + segmentId : ''}" 
                   class="btn btn-sm btn-outline-primary">
                    查看詳情
                </a>
            </div>
        </div>
    `;
}

// 顯示關聯圖
function displayRelationGraph(data) {
    const container = document.getElementById('relationGraphContainer');
    if (!container) return;
    
    container.style.display = 'block';
    const graphElement = document.getElementById('relationGraph');
    
    if (data && data.nodes && data.links && window.RelationGraph) {
        const graph = new RelationGraph(graphElement);
        graph.init(data);
    } else {
        graphElement.innerHTML = '<p class="text-center text-muted">關聯圖功能開發中，或沒有足夠的關聯資料...</p>';
    }
}

// 更新選中標籤顯示
function updateSelectedTagsDisplay(containerId, tagsArray, type) {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    container.innerHTML = tagsArray.map((tag, index) => `
        <span class="badge me-1" style="background-color: ${tag.color || '#6c757d'}">
            ${tag.category ? tag.category + ':' : ''}${tag.name}
            <i class="fas fa-times ms-1" onclick="removeSelectedTag('${type}', ${index})" style="cursor: pointer"></i>
        </span>
    `).join('');
}

// 移除選中標籤
function removeSelectedTag(type, index) {
    if (type === 'symptoms' && selectedTags.symptoms[index]) {
        selectedTags.symptoms.splice(index, 1);
        updateSelectedTagsDisplay('selectedSymptoms', selectedTags.symptoms, 'symptoms');
    } else if (type === 'causes' && selectedTags.causes[index]) {
        selectedTags.causes.splice(index, 1);
        updateSelectedTagsDisplay('selectedCauses', selectedTags.causes, 'causes');
    }
}

// 初始化
document.addEventListener('DOMContentLoaded', function() {
    // 初始化症狀標籤自動完成
    const symptomInput = document.getElementById('symptomInput');
    if (symptomInput) {
        new TagAutocomplete(symptomInput, (tag) => {
            if (!selectedTags.symptoms.find(t => t.id === tag.id)) {
                selectedTags.symptoms.push(tag);
                updateSelectedTagsDisplay('selectedSymptoms', selectedTags.symptoms, 'symptoms');
            }
        }, {
            autoPrefix: true
        });
    }
    
    // 初始化病因標籤自動完成
    const causeInput = document.getElementById('causeInput');
    if (causeInput) {
        new TagAutocomplete(causeInput, (tag) => {
            if (!selectedTags.causes.find(t => t.id === tag.id)) {
                selectedTags.causes.push(tag);
                updateSelectedTagsDisplay('selectedCauses', selectedTags.causes, 'causes');
            }
        }, {
            autoPrefix: true
        });
    }
    
    // 初始化手法輸入自動完成
    const methodInput = document.getElementById('methodInput');
    if (methodInput) {
        new TagAutocomplete(methodInput, (tag) => {
            methodInput.value = tag.name;
        }, {
            autoPrefix: true
        });
    }
    
    // 檢查 URL 參數
    const urlParams = new URLSearchParams(window.location.search);
    const tagParam = urlParams.get('tag');
    if (tagParam) {
        console.log('搜尋標籤:', tagParam);
        // 預設選擇症狀診斷查詢
        selectQueryType('symptom_to_cause');
        
        // 嘗試將標籤添加為症狀
        selectedTags.symptoms.push({
            id: Date.now(),
            name: tagParam,
            category: '症狀',
            color: '#dc3545'
        });
        updateSelectedTagsDisplay('selectedSymptoms', selectedTags.symptoms, 'symptoms');
    }
});
</script>
{% endblock %}
