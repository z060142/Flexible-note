<!-- 修复 session_detail.html 中的关键问题 -->

<!-- 1. 修复文件服务 URL 引用 -->
{% if segment.attachments %}
<div class="mt-3">
    <h6>附件</h6>
    <div class="row">
        {% for attachment in segment.attachments %}
        <div class="col-md-3 mb-2">
            {% if attachment.file_type == 'image' %}
            <img src="{{ url_for('serve_upload', filename=attachment.filename) }}" 
                 class="img-thumbnail attachment-preview" 
                 onclick="viewAttachmentModal('{{ url_for('serve_upload', filename=attachment.filename) }}', '{{ attachment.original_filename }}')">
            {% elif attachment.file_type == 'video' %}
            <div class="text-center p-3 border rounded">
                <i class="fas fa-video fa-3x"></i>
                <p>{{ attachment.original_filename }}</p>
                <a href="{{ url_for('serve_upload', filename=attachment.filename) }}" target="_blank" class="btn btn-sm btn-outline-primary mt-1">播放</a>
            </div>
            {% else %}
            <div class="text-center p-3 border rounded">
                <i class="fas fa-file fa-3x"></i>
                <p>{{ attachment.original_filename }}</p>
                <a href="{{ url_for('serve_upload', filename=attachment.filename) }}" target="_blank" class="btn btn-sm btn-outline-primary mt-1">下載</a>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- 2. 修复 JavaScript 部分 -->
<script>
const sessionId = {{ session.id | tojson | safe }};
let selectedTags = [];
let segmentTagAutocomplete;

// 修复文件上传配置
const uploader = new FileUploader({
    maxSize: 100 * 1024 * 1024, // 100MB
    acceptedTypes: ['image/*', 'video/*', '.pdf', '.doc', '.docx'],
    onProgress: function(percent) {
        const progressBar = document.querySelector('#attachmentProgress .progress-bar');
        if (progressBar) {
            progressBar.style.width = percent + '%';
            progressBar.textContent = Math.round(percent) + '%';
            document.getElementById('attachmentProgress').style.display = 'block';
        }
    },
    onComplete: function(response) {
        console.log('文件上傳成功:', response);
        if (response.filename) {
            const uploadedFiles = document.getElementById('uploadedFiles');
            uploadedFiles.innerHTML += `<div class="alert alert-success small">已上傳: ${response.filename}</div>`;
        }
        // 隱藏進度條
        setTimeout(() => {
            document.getElementById('attachmentProgress').style.display = 'none';
        }, 2000);
    },
    onError: function(error) {
        console.error('文件上傳失敗:', error);
        alert('文件上傳失敗: ' + error);
        document.getElementById('attachmentProgress').style.display = 'none';
    }
});

// 獲取分類顏色函數
function getCategoryColor(category) {
    const categoryColors = {{ category_colors | tojson | safe }};
    return categoryColors[category] || '#6c757d';
}

// 更新標籤顯示
function updateTagDisplay() {
    const container = document.getElementById('selectedTags');
    if (!container) return;
    
    container.innerHTML = selectedTags.map((tag, index) => `
        <span class="badge me-1" style="background-color: ${tag.color || getCategoryColor(tag.category)}; color: #fff;">
            ${tag.category ? tag.category + ':' : ''}${tag.name}
            <i class="fas fa-times ms-1" onclick="removeTag(${index})" style="cursor: pointer"></i>
        </span>
    `).join('');
}

// 移除標籤
function removeTag(index) {
    if (index >= 0 && index < selectedTags.length) {
        selectedTags.splice(index, 1);
        updateTagDisplay();
    }
}

// 打開段落模態框
function openSegmentModal(segmentId = null) {
    const form = document.getElementById('segmentForm');
    if (form) {
        form.reset();
    }
    
    selectedTags = [];
    updateTagDisplay();
    
    // 清理上傳相關元素
    const uploadedFiles = document.getElementById('uploadedFiles');
    if (uploadedFiles) {
        uploadedFiles.innerHTML = '';
    }
    
    const progressBar = document.querySelector('#attachmentProgress .progress-bar');
    if (progressBar) {
        progressBar.style.width = '0%';
        progressBar.textContent = '0%';
    }
    
    const attachmentProgress = document.getElementById('attachmentProgress');
    if (attachmentProgress) {
        attachmentProgress.style.display = 'none';
    }
    
    const segmentTagInputElement = document.getElementById('tagTextInput');
    if (segmentTagInputElement) {
        segmentTagInputElement.value = '';
    }

    if (segmentId) {
        // 編輯模式
        document.getElementById('segmentModalTitle').textContent = '編輯段落';
        document.getElementById('currentSegmentIdStore').value = segmentId;
        
        // 載入段落資料
        fetch(`/api/segment/${segmentId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('載入段落資料失敗');
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    alert(data.error);
                    return;
                }
                
                // 填入資料
                document.getElementById('segmentType').value = data.segment_type || '內容';
                document.getElementById('segmentTitle').value = data.title || '';
                document.getElementById('segmentContent').value = data.content || '';
                
                // 載入標籤
                selectedTags = (data.tags || []).map(tag => {
                    return {
                        name: tag.name,
                        category: tag.category,
                        color: tag.color || getCategoryColor(tag.category)
                    };
                });
                updateTagDisplay();
            })
            .catch(err => {
                console.error("載入段落資料錯誤:", err);
                alert("載入段落資料失敗: " + err.message);
            });
    } else {
        // 新增模式
        document.getElementById('segmentModalTitle').textContent = '新增段落';
        document.getElementById('currentSegmentIdStore').value = '';
    }

    // 初始化標籤自動完成
    if (segmentTagInputElement) {
        // 移除舊的事件監聽器
        const newInput = segmentTagInputElement.cloneNode(true);
        segmentTagInputElement.parentNode.replaceChild(newInput, segmentTagInputElement);
        
        segmentTagAutocomplete = new TagAutocomplete(newInput, (tag) => {
            if (!selectedTags.find(st => st.name === tag.name && st.category === tag.category)) {
                selectedTags.push({
                    name: tag.name,
                    category: tag.category,
                    color: tag.color || document.getElementById('tagColorPicker').value
                });
                updateTagDisplay();
            }
            newInput.value = '';
        });
        
        // 添加 Enter 鍵處理
        newInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                setTimeout(() => {
                    const inputText = newInput.value.trim();
                    if (inputText) {
                        addCustomTagFromText(inputText);
                    }
                }, 50);
            }
        });
    }

    // 顯示模態框
    const modal = new bootstrap.Modal(document.getElementById('segmentModal'));
    modal.show();
}

// 從文字添加自訂標籤
function addCustomTagFromText(tagText) {
    const tagColor = document.getElementById('tagColorPicker').value;
    let category = '其他';
    let name = tagText;

    if (tagText.includes(':')) {
        const parts = tagText.split(':', 2);
        category = parts[0].trim();
        name = parts[1].trim();
    }

    if (name && !selectedTags.find(st => st.name === name && st.category === category)) {
        selectedTags.push({ name: name, category: category, color: tagColor });
        updateTagDisplay();
    }
    
    const tagInput = document.getElementById('tagTextInput');
    if (tagInput) {
        tagInput.value = '';
    }
}

// 新增段落
function addSegment() {
    openSegmentModal();
}

// 編輯段落
function editSegment(segmentId) {
    openSegmentModal(segmentId);
}

// 儲存段落
async function saveSegment() {
    const currentSegmentId = document.getElementById('currentSegmentIdStore').value;
    const data = {
        segment_type: document.getElementById('segmentType').value,
        title: document.getElementById('segmentTitle').value,
        content: document.getElementById('segmentContent').value,
        tags: selectedTags
    };
    
    let url = `/session/${sessionId}/segment`;
    let method = 'POST';
    
    if (currentSegmentId) {
        url = `/api/segment/${currentSegmentId}/update`;
        method = 'POST';
    }
    
    try {
        const response = await fetch(url, {
            method: method,
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (!result.success) {
            throw new Error(result.error || '儲存段落失敗');
        }
        
        const savedSegmentId = currentSegmentId || result.segment_id;
        
        // 處理文件上傳
        const fileInput = document.getElementById('attachmentFile');
        if (fileInput && fileInput.files.length > 0) {
            for (let i = 0; i < fileInput.files.length; i++) {
                try {
                    await uploader.upload(fileInput.files[i], savedSegmentId);
                } catch (uploadError) {
                    console.error('文件上傳錯誤:', uploadError);
                    // 繼續處理其他文件
                }
            }
        }
        
        // 關閉模態框並刷新頁面
        const modalElement = document.getElementById('segmentModal');
        const modalInstance = bootstrap.Modal.getInstance(modalElement);
        if (modalInstance) {
            modalInstance.hide();
        }
        
        // 重新載入頁面以顯示更新
        setTimeout(() => {
            location.reload();
        }, 500);
        
    } catch (error) {
        console.error('儲存失敗:', error);
        alert('儲存失敗: ' + error.message);
    }
}

// 刪除段落
async function deleteSegment(segmentId) {
    if (!confirm('確定要刪除這個段落嗎？此操作無法復原。')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/segment/${segmentId}/delete`, {
            method: 'DELETE'
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
            location.reload();
        } else {
            alert('刪除失敗: ' + (result.error || '未知錯誤'));
        }
    } catch (error) {
        console.error('刪除段落時發生錯誤:', error);
        alert('刪除失敗: ' + error.message);
    }
}

// 按標籤搜尋
function searchByTag(tagName) {
    window.location.href = `/search?tag=${encodeURIComponent(tagName)}`;
}

// 顯示關聯
function showRelations() {
    alert('關聯視圖功能開發中...');
}

// 查看附件模態框
function viewAttachmentModal(imageUrl, imageName) {
    document.getElementById('attachmentViewImage').src = imageUrl;
    document.getElementById('attachmentViewModalLabel').textContent = imageName || '附件預覽';
    const modal = new bootstrap.Modal(document.getElementById('attachmentViewModal'));
    modal.show();
}

// 頁面載入完成後的初始化
document.addEventListener('DOMContentLoaded', () => {
    // 初始化現有標籤的顏色
    document.querySelectorAll('.tag-badge').forEach(badge => {
        const category = badge.dataset.category;
        if (category && !badge.style.backgroundColor) {
            badge.style.backgroundColor = getCategoryColor(category) + '!important';
        }
    });
    
    // 處理匯出按鈕
    const exportButton = document.querySelector(`a[href*="/export"]`);
    if (exportButton) {
        exportButton.addEventListener('click', async (e) => {
            e.preventDefault();
            const url = exportButton.href;
            
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error('匯出失敗: ' + response.statusText);
                }
                
                const blob = await response.blob();
                const downloadUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = downloadUrl;
                
                // 從回應標頭獲取檔案名稱
                const disposition = response.headers.get('Content-Disposition');
                let filename = `session_${sessionId}_export.json`;
                if (disposition && disposition.indexOf('attachment') !== -1) {
                    const filenameRegex = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
                    const matches = filenameRegex.exec(disposition);
                    if (matches != null && matches[1]) {
                        filename = matches[1].replace(/['"]/g, '');
                    }
                }
                
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(downloadUrl);
                a.remove();
            } catch (error) {
                console.error('匯出錯誤:', error);
                alert('匯出失敗: ' + error.message);
            }
        });
    }
});
</script>
