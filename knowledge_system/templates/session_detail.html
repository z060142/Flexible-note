{% extends "base.html" %}

{% block title %}{{ session.title }} - 知識管理系統{% endblock %}

{% block extra_css %}
<style>
    .segment-card {
        border-left: 4px solid #007bff;
        transition: all 0.3s ease;
    }
    
    .segment-card:hover {
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .segment-type-診斷 { border-left-color: #28a745; }
    .segment-type-治療 { border-left-color: #dc3545; }
    .segment-type-理論 { border-left-color: #ffc107; }
    
    .tag-badge {
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .tag-badge:hover {
        transform: scale(1.1);
    }
    
    .attachment-preview {
        max-width: 200px;
        max-height: 200px;
        object-fit: cover;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- 課程標題區 -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h1>{{ session.title }}</h1>
                        <p class="text-muted">
                            <i class="fas fa-calendar"></i> {{ session.date.strftime('%Y年%m月%d日 %H:%M') }}
                        </p>
                    </div>
                    <div>
                        <button class="btn btn-primary" onclick="addSegment()">
                            <i class="fas fa-plus"></i> 新增段落
                        </button>
                        <button class="btn btn-secondary" onclick="showRelations()">
                            <i class="fas fa-project-diagram"></i> 查看關聯
                        </button>
                         <a href="{{ url_for('export_session_json', session_id=session.id) }}" class="btn btn-info" download>
                            <i class="fas fa-download"></i> 匯出課程
                        </a>
                    </div>
                </div>
                
                <div class="mt-3">
                    {% for tag in session.tags %}
                    <span class="badge bg-primary tag-badge" style="background-color: {{ tag.color if tag.color else category_colors.get(tag.category, '#6c757d') }}!important; color: #fff;">
                        {{ tag.name }}
                    </span>
                    {% endfor %}
                </div>
                
                {% if session.overview %}
                <div class="mt-3">
                    <h5>課程概述</h5>
                    <p>{{ session.overview }}</p>
                </div>
                {% endif %}
            </div>
        </div>

        <div id="segmentList">
            {% for segment in segments %}
            <div class="card mb-3 segment-card segment-type-{{ segment.segment_type }}" data-segment-id="{{ segment.id }}">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <span class="badge bg-info">{{ segment.segment_type }}</span>
                            {% if segment.title %}
                            <strong>{{ segment.title }}</strong>
                            {% endif %}
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-primary" onclick="editSegment({{ segment.id }})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteSegment({{ segment.id }})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="segment-content">{{ segment.content|safe }}</div>
                    <div class="mt-3">
                        {% for tag in segment.tags %}
                        <span class="badge bg-secondary tag-badge" 
                              style="background-color: {{ tag.color if tag.color else category_colors.get(tag.category, '#6c757d') }}!important; color: #fff;"
                              onclick="searchByTag('{{ tag.name }}')">
                            <i class="fas fa-tag"></i> {{ tag.name }}
                        </span>
                        {% endfor %}
                    </div>
                    {% if segment.attachments %}
                    <div class="mt-3">
                        <h6>附件</h6>
                        <div class="row">
                            {% for attachment in segment.attachments %}
                            <div class="col-md-3 mb-2">
                                {% if attachment.file_type == 'image' %}
                                <img src="{{ url_for('serve_uploads', filename=attachment.filename) }}" 
                                     class="img-thumbnail attachment-preview" 
                                     onclick="viewAttachmentModal('{{ url_for('serve_uploads', filename=attachment.filename) }}', '{{ attachment.original_filename }}')">
                                {% elif attachment.file_type == 'video' %}
                                <div class="text-center p-3 border rounded">
                                    <i class="fas fa-video fa-3x"></i>
                                    <p>{{ attachment.original_filename }}</p>
                                    <a href="{{ url_for('serve_uploads', filename=attachment.filename) }}" target="_blank" class="btn btn-sm btn-outline-primary mt-1">播放</a>
                                </div>
                                {% else %}
                                <div class="text-center p-3 border rounded">
                                    <i class="fas fa-file fa-3x"></i>
                                    <p>{{ attachment.original_filename }}</p>
                                     <a href="{{ url_for('serve_uploads', filename=attachment.filename) }}" target="_blank" class="btn btn-sm btn-outline-primary mt-1">下載</a>
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<div class="modal fade" id="segmentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="segmentModalTitle">新增段落</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="segmentForm">
                    <input type="hidden" id="currentSegmentIdStore">
                    <div class="mb-3">
                        <label class="form-label">段落類型</label>
                        <select class="form-select" id="segmentType">
                            <option value="診斷">診斷</option> <option value="治療">治療</option>
                            <option value="理論">理論</option> <option value="案例">案例</option>
                            <option value="其他">其他</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">標題（選填）</label>
                        <input type="text" class="form-control" id="segmentTitle">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">內容</label>
                        <textarea class="form-control" id="segmentContent" rows="5"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">標籤</label>
                        <div id="tagInputContainer" class="d-flex align-items-center border rounded p-2">
                            <input type="text" class="form-control me-2" placeholder="輸入標籤名稱..." id="tagTextInput">
                            <input type="color" id="tagColorPicker" class="form-control form-control-color" 
                                   value="#808080" title="選擇標籤顏色" style="width: auto; min-width: 40px;">
                        </div>
                        <div id="selectedTags" class="mt-2"></div>
                        <small class="text-muted">按Enter新增自訂標籤，或從建議中選擇。格式：手法:按壓</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">上傳附件</label>
                        <input type="file" class="form-control" id="attachmentFile" multiple 
                               accept="image/*,video/*,.pdf,.doc,.docx">
                        <div id="attachmentProgress" class="progress mt-2" style="display: none;">
                            <div class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                        </div>
                        <div id="uploadedFiles" class="mt-2"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveSegment()">儲存</button>
            </div>
        </div>
    </div>
</div>

<!-- Attachment Viewer Modal -->
<div class="modal fade" id="attachmentViewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="attachmentViewModalLabel">附件預覽</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img src="" id="attachmentViewImage" class="img-fluid" alt="Attachment Preview">
            </div>
        </div>
    </div>
</div>

<script>
const sessionId = {{ session.id }};
let selectedTags = [];
let segmentTagAutocomplete; // Store instance to manage if needed

const uploader = new FileUploader({ /* ... existing uploader config ... */ });

function getCategoryColor(category) { 
    // This JS function can now use the category_colors passed from Python if needed,
    // or keep its own definition if it's purely for client-side dynamic tags not yet saved.
    // For consistency, it's better if this also uses the same source of truth,
    // but the Jinja templates are the primary concern for this subtask.
    const localCategoryColors = {{ category_colors | tojson | safe }};
    return localCategoryColors[category] || '#6c757d';
}

function updateTagDisplay() { 
    const container = document.getElementById('selectedTags');
    container.innerHTML = selectedTags.map((tag, index) => `
        <span class="badge me-1" style="background-color: ${tag.color || getCategoryColor(tag.category)}; color: #fff;">
            ${tag.category ? tag.category + ':' : ''}${tag.name}
            <i class="fas fa-times ms-1" onclick="removeTag(${index})" style="cursor: pointer"></i>
        </span>
    `).join('');
}

function removeTag(index) { 
    selectedTags.splice(index, 1);
    updateTagDisplay();
}

function openSegmentModal(segmentId = null) {
    document.getElementById('segmentForm').reset();
    selectedTags = [];
    updateTagDisplay();
    document.getElementById('uploadedFiles').innerHTML = ''; 
    document.querySelector('#attachmentProgress .progress-bar').style.width = '0%';
    document.getElementById('attachmentProgress').style.display = 'none';
    
    const segmentTagInputElement = document.getElementById('tagTextInput');
    segmentTagInputElement.value = ''; 

    if (segmentId) {
        document.getElementById('segmentModalTitle').textContent = '編輯段落';
        document.getElementById('currentSegmentIdStore').value = segmentId;
        fetch(`/api/segment/${segmentId}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) { alert(data.error); return; }
                document.getElementById('segmentType').value = data.segment_type;
                document.getElementById('segmentTitle').value = data.title;
                document.getElementById('segmentContent').value = data.content;
                selectedTags = data.tags.map(tag => ({ 
                    name: tag.name, category: tag.category, 
                    color: tag.color || getCategoryColor(tag.category) // Use JS getCategoryColor for fallback
                }));
                updateTagDisplay();
            })
            .catch(err => { console.error("Error fetching segment:", err); alert("載入段落資料失敗"); });
    } else {
        document.getElementById('segmentModalTitle').textContent = '新增段落';
        document.getElementById('currentSegmentIdStore').value = '';
    }

    segmentTagAutocomplete = new TagAutocomplete(segmentTagInputElement, (tag) => {
        if (!selectedTags.find(st => st.name === tag.name && st.category === tag.category)) {
            selectedTags.push({ 
                name: tag.name, 
                category: tag.category, 
                color: tag.color || document.getElementById('tagColorPicker').value 
            });
            updateTagDisplay();
        }
        segmentTagInputElement.value = ''; 
    });
    
    segmentTagInputElement.removeEventListener('keypress', handleTagTextInputKeyPress);
    segmentTagInputElement.addEventListener('keypress', handleTagTextInputKeyPress);

    new bootstrap.Modal(document.getElementById('segmentModal')).show();
}

function handleTagTextInputKeyPress(event) {
    if (event.key === 'Enter') {
        event.preventDefault();
        setTimeout(() => { 
            const inputText = document.getElementById('tagTextInput').value.trim();
            if (inputText) { 
                addCustomTagFromText(inputText);
            }
        }, 50);
    }
}

function addCustomTagFromText(tagText) {
    const tagColor = document.getElementById('tagColorPicker').value;
    let category = '其他';
    let name = tagText;

    if (tagText.includes(':')) {
        const parts = tagText.split(':', 2);
        category = parts[0].trim();
        name = parts[1].trim();
    }

    if (name && !selectedTags.find(st => st.name === name && st.category === category)) {
        selectedTags.push({ name: name, category: category, color: tagColor });
        updateTagDisplay();
    }
    document.getElementById('tagTextInput').value = '';
}


function addSegment() { openSegmentModal(); }
function editSegment(segmentId) { openSegmentModal(segmentId); }
async function saveSegment() { 
    const currentSegmentId = document.getElementById('currentSegmentIdStore').value;
    const data = {
        segment_type: document.getElementById('segmentType').value,
        title: document.getElementById('segmentTitle').value,
        content: document.getElementById('segmentContent').value,
        tags: selectedTags
    };
    let url = `/session/${sessionId}/segment`;
    let method = 'POST';
    if (currentSegmentId) {
        url = `/api/segment/${currentSegmentId}/update`;
    }
    try {
        const response = await fetch(url, {
            method: method, headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data)
        });
        const result = await response.json();
        if (!result.success) throw new Error(result.error || '儲存段落失敗');
        const savedSegmentId = currentSegmentId || result.segment_id;
        const fileInput = document.getElementById('attachmentFile');
        if (fileInput.files.length > 0) {
            for (let i = 0; i < fileInput.files.length; i++) {
                await uploader.upload(fileInput.files[i], savedSegmentId);
            }
        }
        bootstrap.Modal.getInstance(document.getElementById('segmentModal')).hide();
        location.reload();
    } catch (error) {
        console.error('儲存失敗:', error); alert('儲存失敗: ' + error.message);
    }
}
async function deleteSegment(segmentId) { 
    if (confirm('確定要刪除這個段落嗎？此操作無法復原。')) {
        try {
            const response = await fetch(`/api/segment/${segmentId}/delete`, { method: 'DELETE' });
            const result = await response.json();
            if (result.success) {
                location.reload();
            } else {
                alert('刪除失敗: ' + (result.error || '未知錯誤'));
            }
        } catch (error) {
            console.error('刪除段落時發生錯誤:', error);
            alert('刪除失敗，請重試。');
        }
    }
}
function searchByTag(tagName) { window.location.href = `/search?tag=${encodeURIComponent(tagName)}`; }
function showRelations() { alert('關聯視圖功能開發中...'); }

function viewAttachmentModal(imageUrl, imageName) {
    document.getElementById('attachmentViewImage').src = imageUrl;
    document.getElementById('attachmentViewModalLabel').textContent = imageName;
    new bootstrap.Modal(document.getElementById('attachmentViewModal')).show();
}

document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.tag-badge[data-category]').forEach(badge => {
        const category = badge.dataset.category;
        if (!badge.style.backgroundColor) { 
             badge.style.backgroundColor = getCategoryColor(category) + '!important';
        }
    });
    const exportButton = document.querySelector(`a[href*="/export"]`);
    if(exportButton){
        exportButton.addEventListener('click', async (e) => {
            e.preventDefault();
            const url = exportButton.href;
            try {
                const response = await fetch(url);
                if(!response.ok) throw new Error('Export failed: ' + response.statusText);
                const blob = await response.blob();
                const downloadUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = downloadUrl;
                const disposition = response.headers.get('Content-Disposition');
                let filename = `session_${sessionId}_export.json`; 
                if (disposition && disposition.indexOf('attachment') !== -1) {
                    const filenameRegex = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
                    const matches = filenameRegex.exec(disposition);
                    if (matches != null && matches[1]) {
                        filename = matches[1].replace(/['"]/g, '');
                    }
                }
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(downloadUrl);
                a.remove();
            } catch (error) {
                console.error('Export error:', error);
                alert('Export failed.');
            }
        });
    }
});
</script>
{% endblock %}
